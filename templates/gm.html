### FULL POLISHED gm.html ###

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GM Panel - Influence Combat App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
    #sidebar { width: 250px; background: #fff; border-right: 1px solid #ddd; overflow-y: auto; padding: 10px; }
    #main { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9fb; }
    h1 { text-align: center; color: #333; }
    .sidebar-item { padding: 10px; margin-bottom: 5px; background: #eee; border-radius: 5px; cursor: pointer; text-align: center; }
    .sidebar-item:hover, .sidebar-item.active { background: #007bff; color: white; }
    .profile-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: auto; padding: 20px; max-width: 800px; }
    img.profile-photo { max-width: 100%; border-radius: 10px; margin-bottom: 10px; }
    .edit-btn, .influence-btn { padding: 10px 20px; margin: 5px 5px 5px 0; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 14px; }
    .edit-btn { background-color: #28a745; }
    .save-btn { background-color: #17a2b8; }
    .delete-btn { background-color: #dc3545; }
    .reset-btn { background-color: #6c757d; }
    .influence-btn { background-color: #007bff; }
    .section-title { font-weight: bold; margin-top: 10px; color: #555; }
    [contenteditable="true"] { background-color: #eef; border: 1px solid #99f; padding: 4px; border-radius: 4px; }
    ul { padding-left: 20px; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; margin-left: 10px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #dc3545; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(26px); }
    .switch-label { font-size: 12px; margin-left: 5px; vertical-align: middle; }
    .icon-btn { background: none; border: none; cursor: pointer; font-size: 18px; margin-left: 5px; }
    .icon-btn:hover { color: #007bff; }
    .list-item-row { display: flex; align-items: center; margin-bottom: 5px; }
    .list-item-row input[type="text"] { flex: 1; }
    .create-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; }
    .create-form textarea, .create-form input[type="text"], .create-form input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    .create-form input[type="file"] { grid-column: span 2; }
    .create-form button[type="submit"] { grid-column: span 2; width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
<div id="sidebar">
  <h1>Profiles</h1>
  <div id="profile-list"></div>
</div>
<div id="main">
  <div id="main-content"></div>
</div>

<script>
var socket = io();
var profiles = [];
var selectedProfileIndex = 0;

function fetchProfiles() {
  fetch('/api/get_profiles').then(r => r.json()).then(data => { profiles = data; renderSidebar(); renderMain(); });
}

function renderSidebar() {
  const list = document.getElementById('profile-list');
  list.innerHTML = '';

  const createBtn = document.createElement('div');
  createBtn.className = 'sidebar-item' + (selectedProfileIndex === -1 ? ' active' : '');
  createBtn.textContent = '+ Create New';
  createBtn.onclick = () => { selectedProfileIndex = -1; renderSidebar(); renderMain(); };
  list.appendChild(createBtn);

  profiles.forEach((profile, index) => {
    const item = document.createElement('div');
    item.className = 'sidebar-item' + (selectedProfileIndex === index ? ' active' : '');
    item.textContent = profile.name;
    item.onclick = () => { selectedProfileIndex = index; renderSidebar(); renderMain(); };
    list.appendChild(item);
  });
}

function renderMain() {
  const container = document.getElementById('main-content');
  container.innerHTML = '';

  if (selectedProfileIndex === -1) {
    renderCreateForm(container);
    return;
  }

  const p = profiles[selectedProfileIndex];
  const div = document.createElement('div');
  div.className = 'profile-card';

  if (p.photo_filename) {
    div.innerHTML += `<img src="/static/uploads/${p.photo_filename}" alt="Profile Photo" class="profile-photo">`;
  }

  div.innerHTML += `
    <h2><span>${p.name}</span></h2>
    <button class="edit-btn" onclick="enableEditMode(this, ${selectedProfileIndex})">Edit</button>
    <button class="edit-btn delete-btn" onclick="deleteProfile(${selectedProfileIndex})">Delete</button>
    <p><strong>Influence Successes:</strong> 
    <span id="influence-successes">${p.influence_successes}</span> / 
    <span id="successes-needed">${p.successesNeeded ?? ''}</span>
    <button class="influence-btn" onclick="incrementSuccess(${selectedProfileIndex})">+1</button>
    <button class="influence-btn reset-btn" onclick="resetSuccess(${selectedProfileIndex})">Reset</button>
    </p>
  `;

  ['appearance', 'background', 'personality', 'goal', 'attitude', 'benefit', 'special'].forEach(field => {
    div.innerHTML += `<p><strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong> <span>${p[field] || ''}</span></p>`;
  });

  ['biases', 'strengths', 'weaknesses', 'influence_skills'].forEach(cat => {
    div.innerHTML += `<p class="section-title">${cat.replace('_', ' ').toUpperCase()}:</p><div id="${cat}-list">`;

    p[cat].forEach((item, idx) => {
      const revealed = p.revealed[cat][idx];
      div.innerHTML += `
        <div class="list-item-row">
          <span>${item}</span>
          <label class="switch">
            <input type="checkbox" ${revealed ? 'checked' : ''} onchange="handleToggleReveal(this)" data-profile-index="${selectedProfileIndex}" data-category="${cat}" data-item-index="${idx}">
            <span class="slider"></span>
          </label>
          <span class="switch-label">${revealed ? 'Revealed' : 'Hidden'}</span>
        </div>
      `;
    });

    div.innerHTML += `</div>`;
  });

  container.appendChild(div);
}

function renderCreateForm(container) {
  const form = document.createElement('div');
  form.className = 'profile-card';
  form.innerHTML = `
    <h2>Create New Profile</h2>
    <form id="createProfileForm" class="create-form" enctype="multipart/form-data">
      <input type="text" name="name" placeholder="Name" required>
      <input type="number" name="successesNeeded" placeholder="Successes Needed" min="1" value="1">
      <textarea name="appearance" placeholder="Appearance" required></textarea>
      <textarea name="background" placeholder="Background" required></textarea>
      <textarea name="personality" placeholder="Personality" required></textarea>
      <textarea name="goal" placeholder="Goal" required></textarea>
      <textarea name="attitude" placeholder="Attitude" required></textarea>
      <textarea name="benefit" placeholder="Benefit" required></textarea>
      <textarea name="special" placeholder="Special" required></textarea>
      <input type="text" name="biases" placeholder="Biases (semicolon-separated)">
      <input type="text" name="strengths" placeholder="Strengths (semicolon-separated)">
      <input type="text" name="weaknesses" placeholder="Weaknesses (semicolon-separated)">
      <input type="text" name="influence_skills" placeholder="Influence Skills (semicolon-separated)">
      <input type="file" name="photo" accept="image/*">
      <button type="submit" class="edit-btn">Create Profile</button>
    </form>
  `;
  container.appendChild(form);

  document.getElementById('createProfileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    fetch('/api/create_profile', {
      method: 'POST',
      body: formData
    }).then(() => {
      e.target.reset();
      selectedProfileIndex = 0;
      fetchProfiles();
    });
  });
}

socket.on('refresh_profiles', fetchProfiles);
fetchProfiles();
</script>

</body>
</html>
