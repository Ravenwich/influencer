<!-- Updated gm.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GM Panel - Influence Combat App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
    #sidebar { width: 250px; background: #fff; border-right: 1px solid #ddd; overflow-y: auto; padding: 10px; }
    #main { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9fb; }
    h1 { text-align: center; color: #333; }
    .sidebar-item { padding: 10px; margin-bottom: 5px; background: #eee; border-radius: 5px; cursor: pointer; text-align: center; }
    .sidebar-item:hover, .sidebar-item.active { background: #007bff; color: white; }
    .profile-card, .form-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin: auto; padding: 20px; max-width: 800px; }
    .form-card input, .form-card textarea { width: 100%; padding: 8px; margin: 8px 0 16px 0; border: 1px solid #ccc; border-radius: 5px; }
    .form-card button, .edit-btn, .influence-btn { padding: 10px 20px; margin: 5px 5px 5px 0; background-color: #28a745; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 14px; }
    .save-btn { background-color: #17a2b8; }
    .cancel-btn { background-color: #ffc107; color: black; }
    .delete-btn { background-color: #dc3545; }
    .reset-btn { background-color: #6c757d; }
    .influence-btn { background-color: #007bff; }
    img.profile-photo { max-width: 100%; border-radius: 10px; margin-bottom: 10px; }
    .section-title { font-weight: bold; margin-top: 10px; color: #555; }
    [contenteditable="true"] { background-color: #eef; border: 1px solid #99f; padding: 4px; border-radius: 4px; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
<div id="sidebar">
  <h1>Profiles</h1>
  <div id="profile-list"></div>
</div>
<div id="main">
  <div id="main-content"></div>
</div>
<script>
var socket = io();
var profiles = [];
var selectedProfileIndex = 0;

function fetchProfiles() {
  fetch('/api/get_profiles').then(r => r.json()).then(data => { profiles = data; renderSidebar(); renderMain(); });
}

function renderSidebar() {
  const list = document.getElementById('profile-list');
  list.innerHTML = '';

  const createBtn = document.createElement('div');
  createBtn.className = 'sidebar-item' + (selectedProfileIndex === -1 ? ' active' : '');
  createBtn.textContent = '+ Create New';
  createBtn.onclick = function() { selectedProfileIndex = -1; renderSidebar(); renderMain(); };
  list.appendChild(createBtn);

  profiles.forEach((profile, index) => {
    const item = document.createElement('div');
    item.className = 'sidebar-item' + (selectedProfileIndex === index ? ' active' : '');
    item.textContent = profile.name;
    item.onclick = function() { selectedProfileIndex = index; renderSidebar(); renderMain(); };
    list.appendChild(item);
  });
}

function renderMain() {
  const container = document.getElementById('main-content');
  container.innerHTML = '';

  if (selectedProfileIndex === -1) { container.innerHTML = '<div class="form-card"><h2>Create Profile from sidebar only</h2></div>'; return; }

  const p = profiles[selectedProfileIndex];
  const div = document.createElement('div');
  div.className = 'profile-card';

  if (p.photo_filename) div.innerHTML += `<img src="/static/uploads/${p.photo_filename}" alt="Profile Photo" class="profile-photo">`;

  div.innerHTML += `<h2>${p.name}</h2>`;
  div.innerHTML += `<p><strong>Influence Successes:</strong> ${p.influence_successes}</p>`;

  ['appearance','background','personality','goal','attitude','benefit','special'].forEach(field => {
    div.innerHTML += `<p><strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong> ${p[field] || ''}</p>`;
  });

  div.innerHTML += `<p><strong>Successes Needed:</strong> ${p.successesNeeded ?? ''}</p>`;

  ['biases', 'strengths', 'weaknesses', 'influence_skills'].forEach(cat => {
    div.innerHTML += `<p class="section-title">${cat.replace('_', ' ').toUpperCase()}:</p><ul>`;
    p[cat].forEach((item, idx) => {
      const revealed = p.revealed[cat][idx];
      div.innerHTML += `<li>${item} <label class="switch"><input type="checkbox" ${revealed ? 'checked' : ''} onchange="handleToggleReveal(this)" data-profile-index="${selectedProfileIndex}" data-category="${cat}" data-item-index="${idx}"><span class="slider"></span></label> ${revealed ? 'Revealed' : 'Hidden'}</li>`;
    });
    div.innerHTML += `</ul>`;
  });

  container.appendChild(div);
}

function handleToggleReveal(input) {
  const profileIndex = input.getAttribute('data-profile-index');
  const category = input.getAttribute('data-category');
  const itemIndex = input.getAttribute('data-item-index');

  fetch('/api/toggle_reveal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ profile_index: profileIndex, category: category, item_index: itemIndex })
  });
}

socket.on('refresh_profiles', fetchProfiles);
fetchProfiles();
</script>
</body>
</html>
